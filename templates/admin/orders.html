{% extends 'admin/base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-rose-900">
                <i class="bx bx-cart mr-2"></i>
                إدارة الطلبات
            </h1>
            <div class="bg-rose-100 text-rose-900 px-4 py-2 rounded-lg">
                إجمالي الطلبات: {{ orders|length }}
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <!-- Export Buttons -->
            <form action="{{ url_for('admin.export_selected_orders') }}" method="POST" class="inline">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="bx bx-export mr-2"></i> تصدير المحدد
                </button>
            </form>
            <a href="{{ url_for('admin.export_orders') }}" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                <i class="bx bx-download mr-2"></i> تصدير الكل
            </a>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="بحث عن طلب..." 
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                <i class="bx bx-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <select id="statusFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                <option value="">كل الحالات</option>
                <option value="pending">قيد الانتظار</option>
                <option value="completed">مكتمل</option>
                <option value="cancelled">ملغي</option>
            </select>
            <select id="paymentFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                <option value="">كل طرق الدفع</option>
                <option value="cash_on_delivery">الدفع عند الاستلام</option>
                <option value="vodafone_cash">فودافون كاش</option>
                <option value="visa">فيزا / ماستركارد</option>
            </select>
            <select id="shippingFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                <option value="">كل حالات الشحن</option>
                <option value="pending">قيد الانتظار</option>
                <option value="shipped">تم الشحن</option>
                <option value="delivered">تم التوصيل</option>
                <option value="returned">تم الإرجاع</option>
            </select>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b">
                    <tr class="text-sm text-gray-500">
                        <th class="px-6 py-4 text-center">
                            <input type="checkbox" id="select-all" class="form-checkbox h-5 w-5 text-blue-600">
                        </th>
                        <th class="px-6 py-4 text-right">رقم الطلب</th>
                        <th class="px-6 py-4 text-center">العميل</th>
                        <th class="px-6 py-4 text-center">الهاتف</th>
                        <th class="px-6 py-4 text-center">المبلغ</th>
                        <th class="px-6 py-4 text-center">طريقة الدفع</th>
                        <th class="px-6 py-4 text-center">حالة الشحن</th>
                        <th class="px-6 py-4 text-center">تغيير حالة الشحن</th>
                        <th class="px-6 py-4 text-center">الإجراءات</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for order in orders %}
                    <tr class="hover:bg-gray-50 transition-colors" data-status="{{ order.status }}" 
                        data-payment="{{ order.payment_method }}" data-shipping="{{ order.shipping_status }}">
                        <!-- Checkbox -->
                        <td class="px-6 py-4 text-center">
                            <input type="checkbox" name="order_ids" value="{{ order.id }}"
                                class="form-checkbox h-5 w-5 text-blue-600">
                        </td>
                        <!-- Order ID -->
                        <td class="px-6 py-4 font-medium text-gray-900">
                            <div class="flex items-center gap-2">
                                <span>#{{ order.id }}</span>
                                {% if order.tracking_number %}
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    {{ order.tracking_number }}
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <!-- Customer Name -->
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bx bx-user text-gray-400"></i>
                                <span>{{ order.name }}</span>
                            </div>
                        </td>
                        <!-- Phone -->
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <a href="tel:{{ order.phone }}" class="text-rose-600 hover:text-rose-800">
                                    {{ order.phone }}
                                </a>
                                {% if order.email %}
                                <a href="mailto:{{ order.email }}" class="text-blue-600 hover:text-blue-800">
                                    <i class="bx bx-envelope"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                        <!-- Amount -->
                        <td class="px-6 py-4 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="bg-gray-100 px-3 py-1 rounded-full">
                                    {{ order.cod_amount }} ج.م
                                </span>
                                {% if order.payment_status %}
                                <span class="text-xs px-2 py-1 rounded-full
                                    {% if order.payment_status == 'paid' %}bg-green-100 text-green-800
                                    {% elif order.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ order.payment_status }}
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <!-- Payment Method -->
                        <td class="px-6 py-4 text-center">
                            {% if order.payment_method == 'cash_on_delivery' %}
                            <div class="flex items-center justify-center gap-2">
                                <i class="bx bx-money text-green-500"></i>
                                <span>الدفع عند الاستلام</span>
                            </div>
                            {% elif order.payment_method == 'vodafone_cash' %}
                            <div class="flex items-center justify-center gap-2">
                                <i class="bx bx-mobile-alt text-purple-500"></i>
                                <span>فودافون كاش</span>
                            </div>
                            {% elif order.payment_method == 'visa' %}
                            <div class="flex items-center justify-center gap-2">
                                <i class="bx bx-credit-card text-blue-500"></i>
                                <span>فيزا / ماستركارد</span>
                            </div>
                            {% else %}
                            <span class="text-gray-500">غير معروف</span>
                            {% endif %}
                        </td>
                        <!-- Shipping Status -->
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-sm 
                                {% if order.shipping_status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif order.shipping_status == 'shipped' %}bg-blue-100 text-blue-800
                                {% elif order.shipping_status == 'delivered' %}bg-green-100 text-green-800
                                {% elif order.shipping_status == 'returned' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ order.shipping_status }}
                            </span>
                        </td>
                        <!-- Change Shipping Status -->
                        <td class="px-6 py-4 text-center space-x-1">
                            <div class="flex flex-wrap justify-center gap-1">
                                <form action="{{ url_for('admin.update_shipping_status', order_id=order.id) }}"
                                    method="POST" class="inline">
                                    <input type="hidden" name="status" value="pending">
                                    <button type="submit"
                                        class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md hover:bg-yellow-200 text-xs transition-colors">
                                        Pending
                                    </button>
                                </form>
                                <form action="{{ url_for('admin.update_shipping_status', order_id=order.id) }}"
                                    method="POST" class="inline">
                                    <input type="hidden" name="status" value="shipped">
                                    <button type="submit"
                                        class="bg-blue-100 text-blue-800 px-2 py-1 rounded-md hover:bg-blue-200 text-xs transition-colors">
                                        Shipped
                                    </button>
                                </form>
                                <form action="{{ url_for('admin.update_shipping_status', order_id=order.id) }}"
                                    method="POST" class="inline">
                                    <input type="hidden" name="status" value="delivered">
                                    <button type="submit"
                                        class="bg-green-100 text-green-800 px-2 py-1 rounded-md hover:bg-green-200 text-xs transition-colors">
                                        Delivered
                                    </button>
                                </form>
                                <form action="{{ url_for('admin.update_shipping_status', order_id=order.id) }}"
                                    method="POST" class="inline">
                                    <input type="hidden" name="status" value="returned">
                                    <button type="submit"
                                        class="bg-red-100 text-red-800 px-2 py-1 rounded-md hover:bg-red-200 text-xs transition-colors">
                                        Returned
                                    </button>
                                </form>
                            </div>
                        </td>
                        <!-- Actions -->
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <!-- View Details -->
                                <a href="{{ url_for('admin.order_detail', order_id=order.id) }}"
                                    class="text-rose-600 hover:text-rose-800 p-2 rounded-lg hover:bg-rose-50 transition-colors"
                                    title="عرض التفاصيل">
                                    <i class="bx bx-show text-xl"></i>
                                </a>
                                <!-- Ship Order -->
                                <form action="{{ url_for('admin.ship_order', order_id=order.id) }}"
                                    method="POST" class="inline">
                                    <button type="submit"
                                        class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors"
                                        title="شحن الطلب">
                                        <i class="bx bx-truck text-xl"></i>
                                    </button>
                                </form>
                                <!-- Delete Order -->
                                <form action="{{ url_for('admin.delete_order', order_id=order.id) }}"
                                    method="POST" class="inline"
                                    onsubmit="return confirm('هل أنت متأكد من حذف هذا الطلب؟');">
                                    <button type="submit"
                                        class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors"
                                        title="حذف الطلب">
                                        <i class="bx bx-trash text-xl"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Select All Checkbox
    const checkboxes = document.querySelectorAll('.form-checkbox');
    const selectAll = document.getElementById('select-all');
    selectAll.addEventListener('change', function () {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    });
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (!this.checked) {
                selectAll.checked = false;
            } else {
                if ([...checkboxes].every(checkbox => checkbox.checked)) {
                    selectAll.checked = true;
                }
            }
        });
    });

    // Filtering Functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const paymentFilter = document.getElementById('paymentFilter');
    const shippingFilter = document.getElementById('shippingFilter');
    const rows = document.querySelectorAll('tbody tr');

    function filterRows() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const paymentValue = paymentFilter.value;
        const shippingValue = shippingFilter.value;

        rows.forEach(row => {
            const orderId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const customerName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const phone = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            const status = row.dataset.status;
            const payment = row.dataset.payment;
            const shipping = row.dataset.shipping;

            const matchesSearch = orderId.includes(searchTerm) || 
                                customerName.includes(searchTerm) || 
                                phone.includes(searchTerm);
            const matchesStatus = !statusValue || status === statusValue;
            const matchesPayment = !paymentValue || payment === paymentValue;
            const matchesShipping = !shippingValue || shipping === shippingValue;

            row.style.display = matchesSearch && matchesStatus && matchesPayment && matchesShipping ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterRows);
    statusFilter.addEventListener('change', filterRows);
    paymentFilter.addEventListener('change', filterRows);
    shippingFilter.addEventListener('change', filterRows);
</script>
{% endblock %}
