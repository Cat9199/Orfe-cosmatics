{% extends "shop/base.html" %}
{% block content %}

<section class="hero-section d-flex align-items-center py-4" style="background: #f7f7f7;">
      <div class="container">
            <div class="row">
                  <div class="col text-center">
                        <h1 class="display-4">Checkout</h1>
                        <nav aria-label="breadcrumb">
                              <ol class="breadcrumb justify-content-center">
                                    <li class="breadcrumb-item"><a href="{{ url_for('shop.home') }}">Home</a></li>
                                    <li class="breadcrumb-item"><a href="{{ url_for('shop.cart') }}">Cart</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                              </ol>
                        </nav>
                  </div>
            </div>
      </div>
</section>

<section class="py-5">
      <div class="container">
            <form id="checkoutForm" action="{{ url_for('shop.place_order') }}" method="POST">
                  <div class="row">
                        <!-- Shipping & Payment Details -->
                        <div class="col-lg-8 mb-4">
                              <div class="card p-4 shadow-sm">
                                    <h4 class="mb-4">Shipping Information</h4>
                                    <div class="row">
                                          <div class="col-md-6 mb-3">
                                                <label for="name" class="form-label">Full Name</label>
                                                <input type="text" class="form-control" id="name" name="name" required>
                                          </div>
                                          <div class="col-md-6 mb-3">
                                                <label for="email" class="form-label">Email Address
                                                      (optional)
                                                </label>
                                                <input type="email" class="form-control" id="email" name="email">
                                          </div>
                                          <div class="col-md-6 mb-3">
                                                <label for="phone" class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" id="phone" name="phone" required>
                                          </div>
                                          <div class="col-md-6 mb-3">
                                                <label for="address" class="form-label">Shipping Address</label>
                                                <textarea class="form-control" id="address" name="address" rows="2"
                                                      required></textarea>
                                          </div>
                                          {% if total == 7255 %}
                                          <div class="mb-3" style="display: none;">
                                                <label for="promo_code" class="form-label">Promo Code</label>
                                                <input type="text" class="form-control" id="promo_code"
                                                      name="promo_code" placeholder="Enter promo code" value="000">
                                                <small class="form-text text-muted">Enter "loly20" for a 20%
                                                      discount.</small>
                                          </div>
                                          {% endif %}

                                          <div class="col-md-4 mb-3">
                                                <label for="city" class="form-label">المدينة</label>
                                                <select class="form-select" id="city" name="city" required>
                                                      <option value="">اختر المدينة</option>
                                                      {% for city in cities %}
                                                      <option value="{{ city.city_id }}">{{ city.name }}</option>
                                                      {% endfor %}
                                                </select>
                                          </div>
                                          <div class="col-md-4 mb-3">
                                                <label for="zone" class="form-label">المنطقة</label>
                                                <select class="form-select" id="zone" name="zone_id" required disabled>
                                                      <option value="">اختر المنطقة</option>
                                                </select>
                                          </div>
                                          <div class="col-md-4 mb-3">
                                                <label for="district" class="form-label">الحي</label>
                                                <select class="form-select" id="district" name="district_id" required
                                                      disabled>
                                                      <option value="">اختر الحي</option>
                                                </select>
                                          </div>

                                    </div>
                                    <input type="hidden" name="total" value="{{ total }}">

                                    <hr class="my-4">
                                    <h4 class="mb-3">Payment Method</h4>
                                    <div class="row">
                                          <!-- الدفع عند الاستلام -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="{{ url_for('static', filename='images/cashOnD.png') }}"
                                                            alt="Cash on Delivery" class="img-fluid mb-2" width="60">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="cash_on_delivery"
                                                                  value="cash_on_delivery" required checked>
                                                            <label class="form-check-label fw-bold"
                                                                  for="cash_on_delivery">الدفع عند الاستلام</label>
                                                      </div>
                                                </div>
                                          </div>
                                          <!-- فودافون كاش + واتساب -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="https://app.fawaterk.com/clients/payment_options/pay5png"
                                                            alt="Vodafone Cash" class="img-fluid mb-2" width="100">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="vodafone_cash"
                                                                  value="vodafone_cash" required>
                                                            <label class="form-check-label fw-bold"
                                                                  for="vodafone_cash">فودافون كاش + واتساب</label>
                                                      </div>
                                                </div>
                                          </div>

                                          <!-- الدفع بالفيزا (قريبًا) -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="https://app.fawaterk.com/clients/payment_options/Visa_mastercardpng"
                                                            alt="Visa" class="img-fluid mb-2" width="100">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="visa" value="visa" required>
                                                            <label class="form-check-label fw-bold" for="visa">الدفع
                                                                  بالفيزا</label>
                                                      </div>
                                                </div>
                                          </div>

                                          <!-- فوري -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="https://app.fawaterk.com/clients/payment_options/fawrypng"
                                                            alt="Fawry" class="img-fluid mb-2" width="100">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="fawry" value="visa"
                                                                  required>
                                                            <label class="form-check-label fw-bold"
                                                                  for="fawry">فوري</label>
                                                      </div>
                                                </div>
                                          </div>

                                          <!-- أمان -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="https://app.fawaterk.com/clients/payment_options/Amanpng"
                                                            alt="Aman" class="img-fluid mb-2" width="100">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="aman" value="visa" required>
                                                            <label class="form-check-label fw-bold"
                                                                  for="aman">أمان</label>
                                                      </div>
                                                </div>
                                          </div>

                                          <!-- بساطة -->
                                          <div class="col-md-4 mb-3">
                                                <div class="card shadow-sm p-3 text-center">
                                                      <img src="https://app.fawaterk.com/clients/payment_options/basata.png"
                                                            alt="Basata" class="img-fluid mb-2" width="100">
                                                      <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                  name="payment_method" id="basata" value="visa"
                                                                  required>
                                                            <label class="form-check-label fw-bold"
                                                                  for="basata">بساطة</label>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>

                              </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-4">
                              <div class="card p-4 bg-light shadow-sm">
                                    <h4 class="text-dark pb-3 border-bottom">Order Summary</h4>
                                    <div class="order-items my-4">
                                          {% for item in cart_items %}
                                          <div class="d-flex justify-content-between mb-2">
                                                <div>
                                                      <h6 class="mb-0">{{ item.product.name }}</h6>
                                                      <small class="text-muted">Qty: {{ item.quantity }}</small>
                                                </div>
                                                <span class="text-dark">{{ "%.2f"|format(item.product.price *
                                                      item.quantity) }} L.E</span>
                                          </div>
                                          {% endfor %}
                                    </div>
                                    <table class="table">
                                          <tbody>
                                                <tr class="subtotal">
                                                      <th>Subtotal</th>
                                                      <td class="text-end" id="subtotalValue">{{ "%.2f"|format(total) }}
                                                            L.E</td>
                                                </tr>
                                                {% if total == 725 %}
                                                <tr class="discount">
                                                      <th>Discount</th>
                                                      <td class="text-end" id="discountLine">0.00 L.E</td>
                                                </tr>
                                                {% endif %}
                                                {% if total == 725 %}
                                                <tr class="shipping">
                                                      <th>Shipping</th>
                                                      <td class="text-end text-success fw-bold">0.00 L.E</td>
                                                </tr>
                                                <p class="text-success text-center mt-3">
                                                      تهاني! الشحن مجاني عند شراء المنتجين 🌙
                                                </p>
                                                {% else %}
                                                <tr class="shipping">
                                                      <th>Shipping</th>
                                                      <td class="text-end text-muted" id="shippingCost">Calculated at
                                                            checkout</td>
                                                </tr>
                                                {% endif %}

                                                <tr class="total border-top">
                                                      <th>Total</th>
                                                      <td class="text-end fw-bold" id="totalValue">{{
                                                            "%.2f"|format(total) }} L.E</td>
                                                </tr>
                                          </tbody>
                                    </table>

                                    <!-- زر الدفع الموحد -->
                                    <button id="paymentButton" type="submit" class="btn btn-success w-100 mt-3">
                                          تأكيد الطلب والدفع
                                    </button>
                                    <a href="{{ url_for('shop.cart') }}" class="btn btn-outline-dark w-100 mt-2">Return
                                          to Cart</a>
                              </div>
                        </div>
                  </div>
            </form>
      </div>
</section>

<script>
      // Function to update subtotal, discount, and total
      function updateTotals() {
            const originalSubtotal = parseFloat("{{ total }}");
            let discountAmount = 0;

            const promoInput = document.getElementById('promo_code');
            if (promoInput && promoInput.value.trim().toLowerCase() === 'loly20') {
                  discountAmount = originalSubtotal * 0.20;
            }

            const discountedSubtotal = originalSubtotal - discountAmount;
            document.getElementById('subtotalValue').textContent = discountedSubtotal.toFixed(2) + ' L.E';

            // Update discount row if present
            const discountLine = document.getElementById('discountLine');
            if (discountLine) {
                  discountLine.textContent = '-' + discountAmount.toFixed(2) + ' L.E';
            }

            // Retrieve shipping cost if already set (otherwise assume 0)
            const shippingCostElement = document.getElementById('shippingCost');
            let shippingCost = 0;
            if (shippingCostElement && shippingCostElement.textContent !== 'Calculated at checkout') {
                  // Extract numeric value; assuming shippingCostElement.textContent is like "50 L.E"
                  shippingCost = parseFloat(shippingCostElement.textContent);
            }

            // New total = discounted subtotal + shipping cost
            const newTotal = discountedSubtotal + shippingCost;
            document.getElementById('totalValue').textContent = newTotal.toFixed(2) + ' L.E';
      }

      // Listen for changes on the promo code field (if it exists)
      const promoField = document.getElementById('promo_code');
      if (promoField) {
            promoField.addEventListener('input', updateTotals);
      }

      // Update shipping cost when city is changed and then update totals accordingly
      document.getElementById('city').addEventListener('change', async function () {
            const cityId = this.value;
            const zoneSelect = document.getElementById('zone');
            zoneSelect.disabled = false;

            // Fetch zones
            const responseZones = await fetch(`/api/zones?city_id=${cityId}`);
            const dataZones = await responseZones.json();
            const zones = dataZones.zones;
            zoneSelect.innerHTML = '<option value="">اختر المنطقة</option>';
            zones.forEach(zone => {
                  const option = document.createElement('option');
                  option.value = zone.name;
                  option.textContent = zone.name;
                  zoneSelect.appendChild(option);
            });
            document.getElementById('zone').addEventListener('change', async function () {
                  const cityId = document.getElementById('city').value;
                  const districtSelect = document.getElementById('district');
                  districtSelect.disabled = false;
                  const response = await fetch(`/api/districts?city_id=${cityId}`);
                  const data = await response.json();
                  const districts = data.districts;
                  districtSelect.innerHTML = '<option value="">اختر الحي</option>';
                  districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.name;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                  });
            });


            // Fetch shipping cost
            const responseShipping = await fetch(`/api/shipping-cost?city_id=${cityId}`);
            const dataShipping = await responseShipping.json();
            const shippingCost = dataShipping.cost;

            // Update shipping cost element
            const shippingCostElement = document.getElementById('shippingCost');
            if (shippingCostElement) {
                  shippingCostElement.textContent = shippingCost + ' L.E';
            }

            // Update totals now that shipping is known
            updateTotals();
      });

      // Existing validation logic for enabling/disabling the payment button remains unchanged
      const form = document.getElementById('checkoutForm');
      const inputs = form.querySelectorAll('input, select, textarea');
      const paymentButton = document.getElementById('paymentButton');
      paymentButton.disabled = true;

      inputs.forEach(input => {
            input.addEventListener('input', function () {
                  let valid = true;
                  inputs.forEach(input => {
                        if (input.type !== 'email' && !input.value) {
                              valid = false;
                        }
                        // promo code is optional
                        if (input.id === 'promo_code' && input.value.trim().toLowerCase() !== 'loly20') {
                              valid = false;
                        }

                  });
                  paymentButton.disabled = !valid;
            });
      });

      // Existing payment method handler remains unchanged
      function handlePaymentButtonClick(event) {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            if (selectedMethod === "vodafone_cash") {
                  event.preventDefault();
                  const orderDetails = "تفاصيل الطلب:\n" +
                        "الاسم: " + document.getElementById("name").value + "\n" +
                        "المجموع: " + document.getElementById('totalValue').textContent + "\n" +
                        "يرجى تحويل المبلغ إلى رقم فودافون كاش.";
                  const whatsappUrl = "https://wa.me/201030553029?text=" + encodeURIComponent(orderDetails);
                  window.open(whatsappUrl, "_blank");
                  setTimeout(() => {
                        document.getElementById("checkoutForm").submit();
                  }, 1000);
            }
      }
</script>



{% endblock %}